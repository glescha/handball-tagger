name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Krävs för att räkna antal commits (git rev-list)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Web Assets
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Bump Version Code
        run: |
          VERSION_CODE=$(git rev-list --count HEAD)
          echo "Updating versionCode to $VERSION_CODE"
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle

      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/release.keystore

      - name: Build Release APK
        run: cd android && ./gradlew assembleRelease
        env:
          ANDROID_KEYSTORE_FILE: ../release.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Verify Signature
        run: |
          BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
          $ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner verify --verbose android/app/build/outputs/apk/release/app-release.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: handball-tagger-release
          path: android/app/build/outputs/apk/release/app-release.apk